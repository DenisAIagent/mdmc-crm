# Dockerfile pour le backend Node.js MDMC CRM
FROM node:18-alpine AS builder

# Métadonnées
LABEL maintainer="MDMC Music Ads"
LABEL description="CRM Backend - Production Ready"
LABEL version="1.0.0"

# Variables d'environnement
ENV NODE_ENV=production
ENV PORT=5000

# Créer un utilisateur non-root pour la sécurité
RUN addgroup -g 1001 -S nodejs && \
    adduser -S backend -u 1001

# Définir le répertoire de travail
WORKDIR /app

# Copier les fichiers de dépendances
COPY package*.json ./
COPY server/package*.json ./server/

# Installer les dépendances avec optimisation pour la production
RUN npm ci --only=production && \
    npm cache clean --force

# Copier le code source du backend
COPY server/ ./server/
COPY .env.production ./.env

# Créer les répertoires nécessaires
RUN mkdir -p uploads logs && \
    chown -R backend:nodejs /app

# Exposer le port
EXPOSE 5000

# Passer à l'utilisateur non-root
USER backend

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD node ./server/healthcheck.js || exit 1

# Commande de démarrage
CMD ["node", "./server/server.js"]