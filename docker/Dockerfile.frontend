# Dockerfile pour le frontend React MDMC CRM
FROM node:18-alpine AS builder

# Variables d'environnement pour le build
ENV NODE_ENV=production
ENV GENERATE_SOURCEMAP=false

# Définir le répertoire de travail
WORKDIR /app

# Copier les fichiers de dépendances
COPY package*.json ./
COPY client/package*.json ./client/

# Installer les dépendances
RUN npm ci --only=production && \
    cd client && npm ci --only=production

# Copier le code source
COPY client/ ./client/
COPY .env.production ./client/.env.production

# Build de l'application React
RUN cd client && npm run build

# Stage de production avec Nginx
FROM nginx:1.25-alpine AS production

# Métadonnées
LABEL maintainer="MDMC Music Ads"
LABEL description="CRM Frontend - Production Ready"
LABEL version="1.0.0"

# Copier les fichiers buildés
COPY --from=builder /app/client/dist /usr/share/nginx/html

# Copier la configuration Nginx
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# Créer un utilisateur non-root
RUN addgroup -g 1001 -S nginx && \
    adduser -S frontend -u 1001 -G nginx

# Ajuster les permissions
RUN chown -R frontend:nginx /usr/share/nginx/html && \
    chown -R frontend:nginx /var/cache/nginx && \
    chown -R frontend:nginx /var/log/nginx && \
    chown -R frontend:nginx /etc/nginx/conf.d && \
    touch /var/run/nginx.pid && \
    chown -R frontend:nginx /var/run/nginx.pid

# Passer à l'utilisateur non-root
USER frontend

# Exposer le port
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:80/ || exit 1

# Commande de démarrage
CMD ["nginx", "-g", "daemon off;"]